<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="PayrollManager.UI.Views.PayrollRunPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Title and Step Indicator -->
        <StackPanel Grid.Row="0" Margin="0,0,0,24">
            <TextBlock Text="Pay Run" Style="{StaticResource PageTitleStyle}" />
            <TextBlock Text="{x:Bind ViewModel.StepTitle, Mode=OneWay}" 
                       FontSize="16" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
        </StackPanel>

        <!-- Step Indicator Dots -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,24">
            <Ellipse Width="12" Height="12" 
                     Fill="{x:Bind ViewModel.IsStep1, Mode=OneWay, Converter={StaticResource StepIndicatorConverter}}" />
            <Rectangle Width="40" Height="2" Fill="{ThemeResource SystemFillColorNeutralBrush}" VerticalAlignment="Center" />
            <Ellipse Width="12" Height="12" 
                     Fill="{x:Bind ViewModel.IsStep2, Mode=OneWay, Converter={StaticResource StepIndicatorConverter}}" />
            <Rectangle Width="40" Height="2" Fill="{ThemeResource SystemFillColorNeutralBrush}" VerticalAlignment="Center" />
            <Ellipse Width="12" Height="12" 
                     Fill="{x:Bind ViewModel.IsStep3, Mode=OneWay, Converter={StaticResource StepIndicatorConverter}}" />
        </StackPanel>

        <!-- Step Content -->
        <ScrollViewer Grid.Row="2">
            <Grid>
                <!-- Step 1: Pay Period -->
                <Border Style="{StaticResource CardStyle}" 
                        Visibility="{x:Bind ViewModel.IsStep1, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel MaxWidth="600">
                        <TextBlock Text="SELECT PAY PERIOD" Style="{StaticResource SectionTitleStyle}" />
                        
                        <StackPanel>
                            <CalendarDatePicker Header="Period Start" 
                                                Date="{x:Bind ViewModel.PeriodStart, Mode=TwoWay}"
                                                MinWidth="200" />
                            
                            <CalendarDatePicker Header="Period End" 
                                                Date="{x:Bind ViewModel.PeriodEnd, Mode=TwoWay}"
                                                MinWidth="200" />
                            
                            <CalendarDatePicker Header="Pay Date" 
                                                Date="{x:Bind ViewModel.PayDate, Mode=TwoWay}"
                                                MinWidth="200" />
                        </StackPanel>

                        <InfoBar Title="Pay Period Info" 
                                 Message="The default dates are based on your last pay run. Adjust as needed."
                                 IsOpen="True" 
                                 IsClosable="False"
                                 Severity="Informational" />
                    </StackPanel>
                </Border>

                <!-- Step 2: Review Employees with Earnings Input -->
                <StackPanel Visibility="{x:Bind ViewModel.IsStep2, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                            Spacing="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="REVIEW EMPLOYEES &amp; EARNINGS" Style="{StaticResource SectionTitleStyle}" />
                        <CheckBox Grid.Column="1" 
                                  Content="Include inactive employees"
                                  IsChecked="{x:Bind ViewModel.IncludeInactive, Mode=TwoWay}"
                                  VerticalAlignment="Center" />
                    </Grid>
                    
                    <InfoBar Title="Overtime Calculation" 
                             Message="For hourly employees, overtime is paid at 1.5× the regular rate. Enter regular and overtime hours separately."
                             IsOpen="True" 
                             IsClosable="False"
                             Severity="Informational" />
                    
                    <controls:DataGrid AutoGenerateColumns="False"
                                       ItemsSource="{x:Bind ViewModel.EmployeeRows, Mode=OneWay}"
                                       CanUserReorderColumns="True"
                                       CanUserResizeColumns="True"
                                       MaxHeight="500">
                        <controls:DataGrid.Columns>
                            <controls:DataGridCheckBoxColumn Header="Include" Binding="{Binding IsIncluded, Mode=TwoWay}" Width="60" />
                            <controls:DataGridTextColumn Header="Employee" Binding="{Binding FullName}" Width="150" IsReadOnly="True" />
                            <controls:DataGridTemplateColumn Header="Status" Width="80">
                                <controls:DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border CornerRadius="4" Padding="6,2" 
                                                Background="{Binding IsActive, Converter={StaticResource StatusColorConverter}}"
                                                HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding IsActive, Converter={StaticResource StatusTextConverter}}" 
                                                       FontSize="10" FontWeight="Bold"
                                                       Foreground="White" />
                                        </Border>
                                    </DataTemplate>
                                </controls:DataGridTemplateColumn.CellTemplate>
                            </controls:DataGridTemplateColumn>
                            <controls:DataGridTextColumn Header="Type" Binding="{Binding PayType}" Width="70" IsReadOnly="True" />
                            <controls:DataGridTextColumn Header="Rate" Binding="{Binding RateDisplay}" Width="100" IsReadOnly="True" />
                            <controls:DataGridTemplateColumn Header="Regular Hrs" Width="90">
                                <controls:DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <NumberBox Value="{Binding RegularHours, Mode=TwoWay}"
                                                   IsEnabled="{Binding IsHourly}"
                                                   Minimum="0" Maximum="168"
                                                   SpinButtonPlacementMode="Compact"
                                                   Margin="2" />
                                    </DataTemplate>
                                </controls:DataGridTemplateColumn.CellTemplate>
                            </controls:DataGridTemplateColumn>
                            <controls:DataGridTemplateColumn Header="OT Hrs" Width="90">
                                <controls:DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <NumberBox Value="{Binding OvertimeHours, Mode=TwoWay}"
                                                   IsEnabled="{Binding IsHourly}"
                                                   Minimum="0" Maximum="80"
                                                   SpinButtonPlacementMode="Compact"
                                                   Margin="2" />
                                    </DataTemplate>
                                </controls:DataGridTemplateColumn.CellTemplate>
                            </controls:DataGridTemplateColumn>
                            <controls:DataGridTextColumn Header="OT Rate" Binding="{Binding OvertimeRateDisplay}" Width="110" IsReadOnly="True" />
                            <controls:DataGridTemplateColumn Header="Bonus $" Width="100">
                                <controls:DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <NumberBox Value="{Binding BonusAmount, Mode=TwoWay}"
                                                   Minimum="0"
                                                   SpinButtonPlacementMode="Compact"
                                                   Margin="2" />
                                    </DataTemplate>
                                </controls:DataGridTemplateColumn.CellTemplate>
                            </controls:DataGridTemplateColumn>
                            <controls:DataGridTemplateColumn Header="Commission $" Width="110">
                                <controls:DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <NumberBox Value="{Binding CommissionAmount, Mode=TwoWay}"
                                                   Minimum="0"
                                                   SpinButtonPlacementMode="Compact"
                                                   Margin="2" />
                                    </DataTemplate>
                                </controls:DataGridTemplateColumn.CellTemplate>
                            </controls:DataGridTemplateColumn>
                        </controls:DataGrid.Columns>
                    </controls:DataGrid>
                </StackPanel>

                <!-- Step 3: Summary & Generate / Results -->
                <StackPanel Visibility="{x:Bind ViewModel.IsStep3, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                            Spacing="16">
                    
                    <!-- Pre-generation Summary -->
                    <Border Style="{StaticResource CardStyle}"
                            Visibility="{x:Bind ViewModel.IsRunComplete, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                        <StackPanel>
                            <TextBlock Text="PAY RUN SUMMARY" Style="{StaticResource SectionTitleStyle}" />
                            
                            <Grid ColumnSpacing="24" RowSpacing="16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Employees" Style="{StaticResource LabelStyle}" />
                                    <TextBlock Text="{x:Bind ViewModel.IncludedCount, Mode=OneWay}" 
                                               Style="{StaticResource LargeValueStyle}" />
                                </StackPanel>

                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Regular" Style="{StaticResource LabelStyle}" />
                                    <TextBlock Text="{x:Bind ViewModel.EstimatedRegular, Mode=OneWay, Converter={StaticResource CurrencyConverter}}" 
                                               Style="{StaticResource ValueStyle}" />
                                </StackPanel>

                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="Overtime" Style="{StaticResource LabelStyle}" />
                                    <TextBlock Text="{x:Bind ViewModel.EstimatedOvertime, Mode=OneWay, Converter={StaticResource CurrencyConverter}}" 
                                               Style="{StaticResource ValueStyle}" Foreground="{StaticResource AccentBrush}" />
                                </StackPanel>

                                <StackPanel Grid.Column="3">
                                    <TextBlock Text="Bonus/Comm" Style="{StaticResource LabelStyle}" />
                                    <TextBlock Text="{x:Bind ViewModel.EstimatedBonus, Mode=OneWay, Converter={StaticResource CurrencyConverter}}" 
                                               Style="{StaticResource ValueStyle}" />
                                </StackPanel>

                                <StackPanel Grid.Column="4">
                                    <TextBlock Text="Est. Taxes" Style="{StaticResource LabelStyle}" />
                                    <TextBlock Text="{x:Bind ViewModel.EstimatedTaxes, Mode=OneWay, Converter={StaticResource CurrencyConverter}}" 
                                               Style="{StaticResource LargeValueStyle}" Foreground="{StaticResource WarningBrush}" />
                                </StackPanel>

                                <StackPanel Grid.Column="5">
                                    <TextBlock Text="Est. Net" Style="{StaticResource LabelStyle}" />
                                    <TextBlock Text="{x:Bind ViewModel.EstimatedNet, Mode=OneWay, Converter={StaticResource CurrencyConverter}}" 
                                               Style="{StaticResource LargeValueStyle}" Foreground="{StaticResource SuccessBrush}" />
                                </StackPanel>
                            </Grid>

                            <StackPanel>
                                <TextBlock Text="Total Gross" Style="{StaticResource LabelStyle}" />
                                <TextBlock Text="{x:Bind ViewModel.EstimatedGross, Mode=OneWay, Converter={StaticResource CurrencyConverter}}" 
                                           FontSize="28" FontWeight="Bold" />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Post-generation Results -->
                    <StackPanel Visibility="{x:Bind ViewModel.IsRunComplete, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                Spacing="16">
                        <InfoBar Title="Pay Run Complete" 
                                 Message="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                                 IsOpen="True" 
                                 IsClosable="False"
                                 Severity="Success" />

                        <TextBlock Text="GENERATED PAY STUBS" Style="{StaticResource SectionTitleStyle}" />

                        <controls:DataGrid AutoGenerateColumns="False"
                                           ItemsSource="{x:Bind ViewModel.GeneratedStubs, Mode=OneWay}"
                                           IsReadOnly="True"
                                           CanUserReorderColumns="True"
                                           CanUserResizeColumns="True">
                            <controls:DataGrid.Columns>
                                <controls:DataGridTextColumn Header="Employee" Binding="{Binding EmployeeName}" Width="*" />
                                <controls:DataGridTemplateColumn Header="Regular" Width="100">
                                    <controls:DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding RegularPay, Converter={StaticResource CurrencyConverter}}" 
                                                       HorizontalAlignment="Right" VerticalAlignment="Center"
                                                       FontWeight="{Binding IsTotalRow, Converter={StaticResource BoolToFontWeightConverter}}"
                                                       Style="{StaticResource CurrencyStyle}" />
                                        </DataTemplate>
                                    </controls:DataGridTemplateColumn.CellTemplate>
                                </controls:DataGridTemplateColumn>
                                <controls:DataGridTemplateColumn Header="Overtime" Width="100">
                                    <controls:DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding OvertimePay, Converter={StaticResource CurrencyConverter}}" 
                                                       HorizontalAlignment="Right" VerticalAlignment="Center"
                                                       Foreground="{StaticResource AccentBrush}"
                                                       FontWeight="{Binding IsTotalRow, Converter={StaticResource BoolToFontWeightConverter}}"
                                                       Style="{StaticResource CurrencyStyle}" />
                                        </DataTemplate>
                                    </controls:DataGridTemplateColumn.CellTemplate>
                                </controls:DataGridTemplateColumn>
                                <controls:DataGridTemplateColumn Header="Bonus" Width="100">
                                    <controls:DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding BonusPay, Converter={StaticResource CurrencyConverter}}" 
                                                       HorizontalAlignment="Right" VerticalAlignment="Center"
                                                       FontWeight="{Binding IsTotalRow, Converter={StaticResource BoolToFontWeightConverter}}"
                                                       Style="{StaticResource CurrencyStyle}" />
                                        </DataTemplate>
                                    </controls:DataGridTemplateColumn.CellTemplate>
                                </controls:DataGridTemplateColumn>
                                <controls:DataGridTemplateColumn Header="Gross" Width="110">
                                    <controls:DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding GrossPay, Converter={StaticResource CurrencyConverter}}" 
                                                       HorizontalAlignment="Right" VerticalAlignment="Center"
                                                       FontWeight="{Binding IsTotalRow, Converter={StaticResource BoolToFontWeightConverter}}"
                                                       Style="{StaticResource CurrencyStyle}" />
                                        </DataTemplate>
                                    </controls:DataGridTemplateColumn.CellTemplate>
                                </controls:DataGridTemplateColumn>
                                <controls:DataGridTemplateColumn Header="Taxes" Width="100">
                                    <controls:DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding TotalTaxes, Converter={StaticResource CurrencyConverter}}" 
                                                       HorizontalAlignment="Right" VerticalAlignment="Center"
                                                       Foreground="{StaticResource WarningBrush}"
                                                       FontWeight="{Binding IsTotalRow, Converter={StaticResource BoolToFontWeightConverter}}"
                                                       Style="{StaticResource CurrencyStyle}" />
                                        </DataTemplate>
                                    </controls:DataGridTemplateColumn.CellTemplate>
                                </controls:DataGridTemplateColumn>
                                <controls:DataGridTemplateColumn Header="Net Pay" Width="110">
                                    <controls:DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding NetPay, Converter={StaticResource CurrencyConverter}}" 
                                                       HorizontalAlignment="Right" VerticalAlignment="Center"
                                                       Foreground="{StaticResource SuccessBrush}"
                                                       FontWeight="{Binding IsTotalRow, Converter={StaticResource BoolToFontWeightConverter}}"
                                                       Style="{StaticResource CurrencyStyle}" />
                                        </DataTemplate>
                                    </controls:DataGridTemplateColumn.CellTemplate>
                                </controls:DataGridTemplateColumn>
                                <controls:DataGridTemplateColumn Header="YTD Gross" Width="110">
                                    <controls:DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding YtdGross, Converter={StaticResource CurrencyConverter}}" 
                                                       HorizontalAlignment="Right" VerticalAlignment="Center"
                                                       Style="{StaticResource CurrencyStyle}" />
                                        </DataTemplate>
                                    </controls:DataGridTemplateColumn.CellTemplate>
                                </controls:DataGridTemplateColumn>
                            </controls:DataGrid.Columns>
                        </controls:DataGrid>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </ScrollViewer>

        <!-- Navigation Buttons -->
        <Grid Grid.Row="3" Margin="0,24,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal">
                <Button Content="← Back" 
                        Command="{x:Bind ViewModel.GoBackCommand}"
                        IsEnabled="{x:Bind ViewModel.CanGoBack, Mode=OneWay}" />
                
                <Button Content="Next →" 
                        Command="{x:Bind ViewModel.GoNextCommand}"
                        IsEnabled="{x:Bind ViewModel.CanGoNext, Mode=OneWay}" />
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}" 
                              Width="24" Height="24" />
                
                <Button Content="Generate Pay Run" 
                        Style="{StaticResource PrimaryButtonStyle}"
                        Command="{x:Bind ViewModel.GeneratePayRunCommand}"
                        Visibility="{x:Bind ViewModel.IsStep3, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                        IsEnabled="{x:Bind ViewModel.IsRunComplete, Mode=OneWay, Converter={StaticResource InverseBoolConverter}}" />
                
                <Button Content="Start New Pay Run" 
                        Style="{StaticResource PrimaryButtonStyle}"
                        Command="{x:Bind ViewModel.StartNewRunCommand}"
                        Visibility="{x:Bind ViewModel.IsRunComplete, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}" />
            </StackPanel>
        </Grid>
    </Grid>
</Page>
